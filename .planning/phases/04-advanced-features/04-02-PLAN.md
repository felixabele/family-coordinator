---
phase: 04-advanced-features
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - src/config/env.ts
  - src/config/redis.ts
  - src/config/family-members.ts
  - src/db/migrations/003_reminders.sql
  - src/reminders/types.ts
  - src/reminders/scheduler.ts
  - src/reminders/jobs.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Redis service runs alongside PostgreSQL in docker-compose"
    - "BullMQ reminder queue checks for upcoming events on a repeating schedule"
    - "Reminder messages are sent via Signal 1 hour before events"
    - "Duplicate reminders are prevented via sent_reminders database table"
    - "Recurring event instances are tracked by composite key (event_id, event_start)"
    - "Reminder worker handles job failures gracefully with logging"
  artifacts:
    - path: "src/reminders/scheduler.ts"
      provides: "BullMQ queue and worker setup for reminders"
      exports: ["createReminderScheduler", "createReminderWorker"]
    - path: "src/reminders/jobs.ts"
      provides: "Job handlers for checking upcoming events and sending reminders"
      exports: ["checkUpcomingEvents", "sendEventReminder"]
    - path: "src/reminders/types.ts"
      provides: "Type definitions for reminder job data"
      contains: "ReminderJobData"
    - path: "src/config/redis.ts"
      provides: "Redis connection factory for BullMQ"
      exports: ["createRedisConnection"]
    - path: "src/db/migrations/003_reminders.sql"
      provides: "sent_reminders table with composite unique constraint"
      contains: "UNIQUE(event_id, event_start)"
    - path: "docker-compose.yml"
      provides: "Redis service for BullMQ"
      contains: "redis"
  key_links:
    - from: "src/reminders/scheduler.ts"
      to: "src/config/redis.ts"
      via: "Redis connection for BullMQ Queue and Worker"
      pattern: "createRedisConnection"
    - from: "src/reminders/jobs.ts"
      to: "src/db/pool.ts"
      via: "PostgreSQL queries for sent_reminders tracking"
      pattern: "pool.query"
    - from: "src/reminders/jobs.ts"
      to: "src/calendar/operations.ts"
      via: "listEvents to find upcoming events"
      pattern: "listEvents"
---

<objective>
Set up proactive event reminder infrastructure using BullMQ with Redis, including the job queue, worker, database migration for reminder tracking, and job handlers.

Purpose: Enables the bot to proactively send Signal reminders before upcoming events, preventing family members from missing appointments. This is independent infrastructure that will be wired into the main application in Plan 03.

Output: Complete reminder system ready for integration — BullMQ queue/worker, Redis config, sent_reminders table, check-upcoming-events and send-reminder job handlers.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-advanced-features/04-RESEARCH.md

@src/config/env.ts
@src/db/pool.ts
@src/db/migrate.ts
@src/calendar/operations.ts
@src/signal/sender.ts
@src/utils/logger.ts
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, add Redis to docker-compose, create Redis config and migration</name>
  <files>
    package.json
    docker-compose.yml
    src/config/env.ts
    src/config/redis.ts
    src/db/migrations/003_reminders.sql
    src/reminders/types.ts
    src/config/family-members.ts
  </files>
  <action>
**1. Install BullMQ and ioredis:**

```bash
npm install bullmq@5 ioredis@5
```

**2. Add Redis service to docker-compose.yml:**

Add a redis service alongside the existing postgres service:

```yaml
redis:
  image: redis:7-alpine
  ports:
    - "6379:6379"
  volumes:
    - redisdata:/var/lib/redis/data
```

Add `redisdata` to the volumes section (alongside existing `pgdata`).

**3. Add Redis env vars to config (src/config/env.ts):**

Add to the Zod schema:

```typescript
REDIS_HOST: z.string().default('localhost'),
REDIS_PORT: z.coerce.number().default(6379),
```

**4. Create Redis connection factory (src/config/redis.ts):**

Create new file that exports `createRedisConnection(host: string, port: number): IORedis`:

- Import `IORedis` from `ioredis`
- Create connection with `maxRetriesPerRequest: null` (BullMQ requirement per docs)
- Add `lazyConnect: true` for controlled startup
- Return the IORedis instance
- Also export a `closeRedisConnection(connection: IORedis): Promise<void>` helper for graceful shutdown

**5. Create database migration (src/db/migrations/003_reminders.sql):**

```sql
CREATE TABLE IF NOT EXISTS sent_reminders (
  id SERIAL PRIMARY KEY,
  event_id TEXT NOT NULL,
  event_start TIMESTAMPTZ NOT NULL,
  sent_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(event_id, event_start)
);

CREATE INDEX IF NOT EXISTS idx_sent_reminders_event ON sent_reminders(event_id, event_start);
```

CRITICAL: Use composite UNIQUE constraint on (event_id, event_start) to prevent duplicate reminders for recurring event instances (see research pitfall 5). Each recurring event instance has the same event_id but different event_start times.

**6. Create reminder types (src/reminders/types.ts):**

```typescript
export interface ReminderJobData {
  eventId: string;
  eventSummary: string;
  eventStart: string; // ISO datetime
}

export interface CheckUpcomingEventsResult {
  eventsChecked: number;
  remindersScheduled: number;
}
```

**7. Add getAllPhoneNumbers to FamilyWhitelist (src/config/family-members.ts):**

Add method to `FamilyWhitelist` class (needed by `sendEventReminder` in Task 2 to send reminders to all family members):

```typescript
/**
 * Get all registered phone numbers
 *
 * @returns Array of phone numbers in E.164 format
 */
getAllPhoneNumbers(): string[] {
  return Array.from(this.members.keys());
}
```

  </action>
  <verify>
Run `npx tsc --noEmit` — zero errors. Verify `grep "bullmq" package.json` shows dependency. Verify `grep "ioredis" package.json` shows dependency. Verify docker-compose.yml contains redis service. Verify src/config/redis.ts exists. Verify src/db/migrations/003_reminders.sql exists with UNIQUE constraint. Verify src/reminders/types.ts exists. Verify `grep "getAllPhoneNumbers" src/config/family-members.ts` shows the new method.
  </verify>
  <done>
BullMQ and ioredis installed. Redis added to docker-compose. Redis connection factory created with BullMQ-compatible settings. Database migration for sent_reminders table with composite unique constraint on (event_id, event_start). Reminder type definitions created. FamilyWhitelist extended with getAllPhoneNumbers method for reminder distribution. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create reminder scheduler (queue/worker) and job handlers</name>
  <files>
    src/reminders/scheduler.ts
    src/reminders/jobs.ts
  </files>
  <action>
**1. Create reminder scheduler (src/reminders/scheduler.ts):**

Exports factory functions (not module-level singletons) for testability and controlled startup:

`createReminderScheduler(connection: IORedis): { queue: Queue; startChecking: () => Promise<void> }`:

- Create a BullMQ `Queue` named `"event-reminders"` with the provided connection
- `startChecking()` adds a repeating job `"check-upcoming-events"` with cron pattern `"*/5 * * * *"` (every 5 minutes)
- Log queue creation

`createReminderWorker(connection: IORedis, deps: ReminderWorkerDeps): Worker`:

- `ReminderWorkerDeps` interface: `{ calendarClient: CalendarClient; signalClient: SignalClient; pool: Pool; familyWhitelist: FamilyWhitelist; timezone: string }`
- Create a BullMQ `Worker` on `"event-reminders"` queue
- Worker processor routes by job.name:
  - `"check-upcoming-events"` → call `checkUpcomingEvents(queue, deps)`
  - `"send-reminder"` → call `sendEventReminder(job.data as ReminderJobData, deps)`
- Set `concurrency: 1` (low-volume family use case)
- Register `completed` and `failed` event handlers with structured logging (Pino)
- Return the worker instance

Also export `closeReminderSystem(queue: Queue, worker: Worker): Promise<void>` for graceful shutdown:

- `await worker.close()`
- `await queue.close()`

**2. Create job handlers (src/reminders/jobs.ts):**

`checkUpcomingEvents(queue: Queue, deps: ReminderWorkerDeps): Promise<CheckUpcomingEventsResult>`:

- Get current time in timezone using `DateTime.now().setZone(deps.timezone)`
- Query calendar for today's events using `listEvents(deps.calendarClient, today)`
- Query calendar for tomorrow's events using `listEvents(deps.calendarClient, tomorrow)`
- For each non-all-day event:
  - Parse event startTime to DateTime
  - Calculate hours until event: `eventStart.diff(now, 'hours').hours`
  - If between 0.9 and 1.1 hours away (the ~1 hour window):
    - Check sent_reminders table: `SELECT 1 FROM sent_reminders WHERE event_id = $1 AND event_start = $2`
    - If NOT already sent, add a `"send-reminder"` job to the queue with `ReminderJobData`
- Return `{ eventsChecked, remindersScheduled }` counts
- Log summary

`sendEventReminder(data: ReminderJobData, deps: ReminderWorkerDeps): Promise<void>`:

- Parse event start time, format as `HH:mm` using Luxon
- Build German reminder text: `"Erinnerung: ${data.eventSummary} um ${formattedTime} Uhr"`
- Determine recipients: call `deps.familyWhitelist.getAllPhoneNumbers()` (added in Task 1) to get all family member phone numbers. Send reminder to each member individually using `sendSignalMessage`.
- After successful send, insert into sent_reminders: `INSERT INTO sent_reminders (event_id, event_start, sent_at) VALUES ($1, $2, NOW())`
- Log reminder sent with eventId and summary

**Important implementation details:**

- Import `sendSignalMessage` from `../signal/sender.js` (not direct signalClient.send)
- Import `listEvents` from `../calendar/operations.js`
- Use Pool from deps for database queries (not global import)
- All imports use `.js` extension for ESM compatibility
- CRITICAL: BullMQ requires queue and worker to use SEPARATE ioredis instances. Each factory function (`createReminderScheduler` and `createReminderWorker`) accepts its OWN `connection: IORedis` parameter. The CALLER (Plan 04-03, `src/index.ts`) is responsible for creating TWO separate Redis connections via `createRedisConnection()` — one for the queue and one for the worker. Do NOT create connections internally; accept them as parameters for testability and explicit lifecycle management.
  </action>
  <verify>
  Run `npx tsc --noEmit` — zero errors. Verify src/reminders/scheduler.ts exports createReminderScheduler and createReminderWorker. Verify src/reminders/jobs.ts exports checkUpcomingEvents and sendEventReminder. Grep for "sent_reminders" in jobs.ts to confirm dedup tracking. Grep for "Erinnerung:" in jobs.ts to confirm German reminder text.
  </verify>
  <done>
  Reminder scheduler with BullMQ queue (every 5 min check) and worker created with factory pattern. Job handlers check upcoming events within 1-hour window, prevent duplicate reminders via PostgreSQL sent_reminders table, and send German reminder messages via Signal to all family members. Graceful shutdown helper exported. TypeScript compiles cleanly.
  </done>
  </task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep "bullmq" package.json` shows dependency
3. `grep "ioredis" package.json` shows dependency
4. `grep "redis" docker-compose.yml` shows redis service
5. `grep "REDIS_HOST" src/config/env.ts` shows env var
6. `grep "createRedisConnection" src/config/redis.ts` shows factory
7. `grep "003_reminders" src/db/migrations/003_reminders.sql` confirms migration exists
8. `grep "UNIQUE(event_id, event_start)" src/db/migrations/003_reminders.sql` confirms composite key
9. `grep "createReminderScheduler" src/reminders/scheduler.ts` shows factory
10. `grep "createReminderWorker" src/reminders/scheduler.ts` shows worker factory
11. `grep "checkUpcomingEvents" src/reminders/jobs.ts` shows job handler
12. `grep "sendEventReminder" src/reminders/jobs.ts` shows job handler
13. `grep "Erinnerung:" src/reminders/jobs.ts` shows German text
14. `grep "sent_reminders" src/reminders/jobs.ts` shows dedup tracking
</verification>

<success_criteria>

- BullMQ and ioredis installed as production dependencies
- Redis service in docker-compose with persistent volume
- Redis connection factory with BullMQ-compatible settings (maxRetriesPerRequest: null)
- REDIS_HOST and REDIS_PORT env vars in Zod config schema
- sent_reminders table with composite UNIQUE(event_id, event_start) constraint
- Reminder queue checks every 5 minutes for upcoming events
- Reminders sent ~1 hour before events in German casual tone
- Duplicate reminders prevented via PostgreSQL unique constraint
- Graceful shutdown helper for queue and worker
- All TypeScript compiles cleanly with zero errors
  </success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-features/04-02-SUMMARY.md`
</output>

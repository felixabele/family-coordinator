---
phase: 01-foundation-signal-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/config/env.ts
  - src/config/constants.ts
  - src/utils/errors.ts
  - src/signal/types.ts
  - src/signal/client.ts
autonomous: true
user_setup:
  - service: signal-cli
    why: "Signal messaging requires a registered phone number with signal-cli"
    env_vars:
      - name: SIGNAL_PHONE_NUMBER
        source: "Your dedicated Signal phone number in E.164 format (e.g., +12025551234)"
    dashboard_config:
      - task: "Register phone number with signal-cli (one-time CAPTCHA required)"
        location: "Run signal-cli register command, complete CAPTCHA at https://signalcaptchas.org/registration/generate.html"

must_haves:
  truths:
    - "Project dependencies include signal-sdk and exclude bullmq, fastify, ioredis, @fastify/rate-limit"
    - "Environment validation requires SIGNAL_PHONE_NUMBER instead of WhatsApp variables"
    - "Signal client wrapper initializes with phone number and retry/rate-limit config"
  artifacts:
    - path: "package.json"
      provides: "Updated dependencies for Signal"
      contains: "signal-sdk"
    - path: "src/config/env.ts"
      provides: "Environment validation with Signal variables"
      contains: "SIGNAL_PHONE_NUMBER"
    - path: "src/config/constants.ts"
      provides: "App constants without WhatsApp/queue references"
      contains: "SESSION_TTL_MS"
    - path: "src/utils/errors.ts"
      provides: "Signal-specific error classes"
      contains: "SignalConnectionError"
    - path: "src/signal/types.ts"
      provides: "TypeScript types for Signal messages"
      contains: "SignalMessage"
    - path: "src/signal/client.ts"
      provides: "Signal client wrapper"
      contains: "createSignalClient"
  key_links:
    - from: "src/signal/client.ts"
      to: "src/config/env.ts"
      via: "SIGNAL_PHONE_NUMBER env var"
      pattern: "SIGNAL_PHONE_NUMBER"
    - from: "src/signal/client.ts"
      to: "signal-sdk"
      via: "npm dependency"
      pattern: "import.*signal-sdk"
---

<objective>
Update project configuration for Signal and create the Signal client foundation layer.

Purpose: Replace WhatsApp dependencies and configuration with Signal equivalents. Create the typed Signal client wrapper that all other Signal modules will depend on. This is the foundation that Plans 02 and 03 build upon.

Output: Updated package.json, env validation, constants, error classes, Signal types, and Signal client wrapper.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-signal-infrastructure/01-RESEARCH.md

@src/config/env.ts
@src/config/constants.ts
@src/utils/errors.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update dependencies and configuration for Signal</name>
  <files>
    package.json
    src/config/env.ts
    src/config/constants.ts
    src/utils/errors.ts
  </files>
  <action>
    **1. Update package.json dependencies:**
    - Remove: `bullmq`, `ioredis`, `fastify`, `@fastify/rate-limit`
    - Add: `signal-sdk` (install via `npm install signal-sdk`)
    - Keep: `@anthropic-ai/sdk`, `date-fns`, `pg`, `pino`, `pino-pretty`, `zod`
    - Update description from "WhatsApp" to "Signal"
    - Update dev script to: `"dev": "tsx watch src/index.ts"`
    - Keep start script as-is (node --experimental-strip-types)
    - If `signal-sdk` is not on npm, install from GitHub: `npm install github:benoitpetit/signal-sdk`
    - Run `npm install` after changes

    **2. Update src/config/env.ts:**
    - Remove all 4 WHATSAPP_* env variables
    - Remove REDIS_URL (no longer needed)
    - Remove PORT (no HTTP server)
    - Add: `SIGNAL_PHONE_NUMBER: z.string().regex(/^\+[1-9]\d{1,14}$/, 'Must be E.164 format (e.g., +12025551234)')`
    - Keep: ANTHROPIC_API_KEY, DATABASE_URL, NODE_ENV, LOG_LEVEL

    **3. Update src/config/constants.ts:**
    - Remove: `WHATSAPP_API_VERSION`, `QUEUE_NAME`, `MAX_CONCURRENT_JOBS`
    - Keep: `SESSION_TTL_MS`, `PROCESSED_MESSAGE_TTL`, `MAX_HISTORY_MESSAGES`
    - Add: `SIGNAL_MAX_CONCURRENT = 5` (concurrent message processing limit)
    - Add: `SIGNAL_RATE_LIMIT_MS = 200` (minimum interval between Signal API calls)
    - Add: `SIGNAL_RETRY_MAX_ATTEMPTS = 3`
    - Add: `SIGNAL_RETRY_INITIAL_DELAY_MS = 1000`
    - Add: `SIGNAL_RETRY_MAX_DELAY_MS = 10000`

    **4. Update src/utils/errors.ts:**
    - Remove: `WebhookValidationError`, `WhatsAppApiError`
    - Keep: `IntentExtractionError`
    - Add: `SignalConnectionError` (extends Error, code = 'SIGNAL_CONNECTION_ERROR') for daemon connection failures
    - Add: `SignalSendError` (extends Error, code = 'SIGNAL_SEND_ERROR') for message send failures
    - Add: `MessageProcessingError` (extends Error, code = 'MESSAGE_PROCESSING_ERROR') for message handler failures
    - Follow same pattern as existing error classes (constructor with message, Error.captureStackTrace)
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compilation passes.
    Run `npm ls signal-sdk` to verify signal-sdk is installed.
    Verify `bullmq`, `ioredis`, `fastify` are NOT in node_modules: `npm ls bullmq 2>&1 | grep -c "empty"` should be non-zero or command should error.
  </verify>
  <done>
    package.json has signal-sdk dependency and no WhatsApp/BullMQ/Redis/Fastify dependencies.
    env.ts validates SIGNAL_PHONE_NUMBER in E.164 format and no longer requires WhatsApp variables.
    constants.ts has Signal-specific constants and no WhatsApp/queue constants.
    errors.ts has SignalConnectionError, SignalSendError, MessageProcessingError instead of WhatsApp errors.
    `npx tsc --noEmit` passes (may need to temporarily ignore index.ts and files importing removed modules).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Signal types and client wrapper</name>
  <files>
    src/signal/types.ts
    src/signal/client.ts
  </files>
  <action>
    **1. Create src/signal/types.ts:**
    Define TypeScript interfaces for Signal message handling:

    ```typescript
    // SignalEnvelope - the outer message envelope from signal-cli
    interface SignalEnvelope {
      source: string;          // Sender phone number (E.164)
      sourceNumber: string;    // Same as source
      sourceName?: string;     // Sender's Signal profile name
      timestamp: number;       // Unix epoch milliseconds (unique message ID)
      dataMessage?: SignalDataMessage;
      syncMessage?: unknown;   // Ignore sync messages
      typingMessage?: unknown; // Ignore typing indicators
    }

    // SignalDataMessage - the actual message content
    interface SignalDataMessage {
      message: string | null;  // Text content (null for media-only)
      timestamp: number;
      groupInfo?: { groupId: string; type: string };
      attachments?: SignalAttachment[];
    }

    // SignalAttachment - for future media support
    interface SignalAttachment {
      contentType: string;
      filename?: string;
      size: number;
    }

    // SignalIncomingMessage - our processed internal type
    interface SignalIncomingMessage {
      messageId: string;       // envelope.timestamp.toString()
      phoneNumber: string;     // envelope.source (E.164)
      senderName?: string;     // envelope.sourceName
      text: string;            // dataMessage.message
      timestamp: Date;         // new Date(envelope.timestamp)
      isGroup: boolean;        // !!dataMessage.groupInfo
      groupId?: string;        // dataMessage.groupInfo?.groupId
    }
    ```

    Export all interfaces. Do NOT use `any` types.

    **2. Create src/signal/client.ts:**
    Create a thin wrapper around signal-sdk that provides a configured SignalCli instance.

    ```typescript
    import { SignalCli } from 'signal-sdk';
    import {
      SIGNAL_MAX_CONCURRENT,
      SIGNAL_RATE_LIMIT_MS,
      SIGNAL_RETRY_MAX_ATTEMPTS,
      SIGNAL_RETRY_INITIAL_DELAY_MS,
      SIGNAL_RETRY_MAX_DELAY_MS,
    } from '../config/constants.js';
    import { logger } from '../utils/logger.js';
    ```

    Export a `createSignalClient(phoneNumber: string): SignalCli` function that:
    - Creates a new SignalCli instance with the phone number
    - Configures retryConfig from constants (maxAttempts, initialDelay, maxDelay, backoffMultiplier: 2)
    - Configures rateLimiter from constants (maxConcurrent, minInterval)
    - Logs client creation at info level
    - Returns the configured instance

    Also export a type alias `type SignalClient = SignalCli` for our internal use.

    NOTE: If signal-sdk's API differs from what the research suggests (e.g., different constructor signature, different import path), adapt accordingly. The research is MEDIUM-HIGH confidence. Check the actual installed package's types/exports. If signal-sdk is not installable at all, create a minimal wrapper that shells out to signal-cli via child_process JSON-RPC as a fallback - document this clearly.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compilation passes for the new files.
    Verify files exist: `ls src/signal/types.ts src/signal/client.ts`
    Verify exports: `grep -c "export" src/signal/types.ts` should be >= 4 (at least 4 interfaces exported).
    Verify SignalCli import works: `grep "SignalCli\|signal-sdk" src/signal/client.ts`
  </verify>
  <done>
    src/signal/types.ts exports SignalEnvelope, SignalDataMessage, SignalAttachment, SignalIncomingMessage interfaces.
    src/signal/client.ts exports createSignalClient function and SignalClient type.
    TypeScript compilation passes for these files.
    Client wrapper configures retry and rate limiting from constants.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (may need to exclude files that import removed modules - index.ts, webhook/*, queue/*, messaging/*)
2. signal-sdk is installed and importable
3. No WhatsApp/BullMQ/Redis/Fastify dependencies remain in package.json
4. New Signal types and client are properly typed (no `any`)
</verification>

<success_criteria>
- Project dependencies updated from WhatsApp to Signal stack
- Environment validation requires Signal phone number, not WhatsApp credentials
- Signal client wrapper creates configured signal-sdk instance
- TypeScript types cover all Signal message structures
- No compilation errors in new/modified files
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-signal-infrastructure/01-01-SUMMARY.md`
</output>

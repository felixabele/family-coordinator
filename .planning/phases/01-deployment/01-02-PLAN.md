---
phase: 01-deployment
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Bot is running on VPS and responding to Signal messages"
    - "Health check endpoint responds on VPS"
    - "PostgreSQL is running and migrations have been applied"
    - "PM2 auto-restarts the bot after crash"
    - "Backup cron job is scheduled and produces valid backups"
  artifacts: []
  key_links: []
---

<objective>
Deploy the Family Coordinator Signal bot to the production VPS and verify everything works end-to-end.

Purpose: Confirm the deployment artifacts from Plan 01 work correctly on the actual VPS -- bot responds to messages, health check works, PM2 manages the process, and backups are scheduled.

Output: Running production bot with verified health checks, process management, and backup automation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-deployment/01-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Deploy to VPS and verify</name>
  <action>
Deploy the application to the VPS. This requires SSH access and manual steps that Claude cannot perform.
  </action>
  <instructions>
### Pre-requisites (one-time VPS setup)

1. **Install Node.js 22** on VPS:

   ```bash
   curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
   sudo apt install -y nodejs
   ```

2. **Install PostgreSQL** on VPS:

   ```bash
   sudo apt install -y postgresql
   sudo -u postgres createuser family_coordinator
   sudo -u postgres createdb -O family_coordinator family_coordinator
   sudo -u postgres psql -c "ALTER USER family_coordinator PASSWORD 'your-secure-password';"
   ```

3. **Install PM2** globally:

   ```bash
   sudo npm install -g pm2
   pm2 startup systemd  # Follow the output to enable auto-start on boot
   ```

4. **signal-cli** should already be installed and registered (per your setup).

### Deploy

1. **Clone the repo** (first time) or **run deploy script** (subsequent):

   ```bash
   # First time:
   git clone <repo-url> /opt/family-coordinator
   cd /opt/family-coordinator
   cp .env.production.example .env.production
   # Edit .env.production with real values

   # Subsequent deploys:
   /opt/family-coordinator/scripts/deploy.sh
   ```

2. **First-time only -- install deps and run migrations:**

   ```bash
   cd /opt/family-coordinator
   npm ci --omit=dev
   node --env-file=.env.production --experimental-strip-types src/db/migrate.ts
   ```

3. **Start with PM2:**

   ```bash
   cd /opt/family-coordinator
   pm2 start ecosystem.config.cjs
   pm2 save
   ```

4. **Schedule backups** (add to crontab with `crontab -e`):
   ```
   0 2 * * * /opt/family-coordinator/scripts/backup.sh >> /opt/family-coordinator/logs/backup.log 2>&1
   ```

### Verify

1. **Check PM2 status:**

   ```bash
   pm2 status
   # Should show "family-coordinator" as "online"
   ```

2. **Check health endpoint:**

   ```bash
   curl http://localhost:3000/health
   # Should return {"status":"healthy","checks":{"database":true},...}
   ```

3. **Send a test Signal message** to the bot phone number (e.g., "Was steht heute an?") and verify it responds.

4. **Test PM2 auto-restart:**

   ```bash
   pm2 stop family-coordinator
   pm2 start family-coordinator
   # Verify it comes back online
   ```

5. **Test backup script:**
   ```bash
   /opt/family-coordinator/scripts/backup.sh
   ls ~/backups/family-coordinator/
   # Should show a .sql.gz file
   ```
     </instructions>
     <resume-signal>Type "deployed" when the bot is running on VPS and all verification steps pass, or describe any issues encountered.</resume-signal>
   </task>

</tasks>

<verification>
1. PM2 shows "family-coordinator" as "online"
2. `curl http://localhost:3000/health` returns healthy status
3. Signal message gets a response from the bot
4. Backup script produces a valid .sql.gz file
5. PM2 restarts the bot automatically after stop/start
</verification>

<success_criteria>
Family Coordinator Signal bot is running in production on VPS, managed by PM2 with auto-restart, health check endpoint accessible, and daily PostgreSQL backups scheduled via cron.
</success_criteria>

<output>
After completion, create `.planning/phases/01-deployment/01-02-SUMMARY.md`
</output>

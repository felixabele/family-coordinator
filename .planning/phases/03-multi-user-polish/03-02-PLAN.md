---
phase: 03-multi-user-polish
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/signal/listener.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Only whitelisted phone numbers can interact with the bot"
    - "Unknown senders receive a polite rejection message"
    - "Non-text messages (images, voice notes, stickers) get rejected with German message"
    - "Help command shows capabilities and resets conversation state"
    - "Cancel command clears conversation and confirms in German"
    - "Commands are detected before LLM call (no wasted API calls)"
    - "Bot responds in both 1:1 and group chats"
    - "Bot personalizes responses with family member name on greeting/new session"
  artifacts:
    - path: "src/signal/listener.ts"
      provides: "Access control, command detection, non-text rejection, group chat support"
      contains: "detectCommand"
    - path: "src/index.ts"
      provides: "Family whitelist loading at startup"
      contains: "loadFamilyConfig"
  key_links:
    - from: "src/signal/listener.ts"
      to: "src/config/family-members.ts"
      via: "FamilyWhitelist.isAllowed() and .getName()"
      pattern: "familyWhitelist\\.isAllowed"
    - from: "src/index.ts"
      to: "src/config/family-members.ts"
      via: "loadFamilyConfig() at startup"
      pattern: "loadFamilyConfig"
    - from: "src/signal/listener.ts"
      to: "src/state/conversation.ts"
      via: "clearState() on help/cancel commands"
      pattern: "clearState"
---

<objective>
Wire family whitelist into the message processing pipeline with access control, command detection (help/cancel), non-text message rejection, group chat support, and personalized responses.

Purpose: Complete multi-user support — the bot now identifies family members, rejects unknowns, handles utility commands without LLM, and works in group chats.
Output: Modified `src/signal/listener.ts` and `src/index.ts`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-user-polish/03-RESEARCH.md
@.planning/phases/03-multi-user-polish/03-01-SUMMARY.md
@src/signal/listener.ts
@src/signal/types.ts
@src/signal/sender.ts
@src/index.ts
@src/state/conversation.ts
@src/config/family-members.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add command detection and access control to message listener</name>
  <files>src/signal/listener.ts</files>
  <action>
Modify `src/signal/listener.ts` with the following changes:

1. **Import FamilyWhitelist:**

   ```typescript
   import type { FamilyWhitelist } from "../config/family-members.js";
   ```

2. **Update MessageListenerDeps interface** — add `familyWhitelist: FamilyWhitelist`

3. **Add `detectCommand` function** (before `setupMessageListener`):

   ```typescript
   function detectCommand(text: string): "help" | "cancel" | null {
     const normalized = text.trim().toLowerCase();
     if (["hilfe", "help", "?"].includes(normalized)) return "help";
     if (["abbrechen", "cancel", "reset"].includes(normalized)) return "cancel";
     return null;
   }
   ```

4. **Add `handleCommand` async function:**
   - Parameters: `command: "help" | "cancel"`, `phoneNumber: string`, `deps: MessageListenerDeps`
   - Always call `deps.conversationStore.clearState(phoneNumber)` first
   - If "help": send help text (reuse the existing help text from `handleIntent`'s help case, but add the line `Schreib "abbrechen" um neu zu starten.` at the end)
   - If "cancel": send `"Alles klar, was kann ich für dich tun?"` (exact wording from user decision)
   - Log with `logger.info({ phoneNumber, command }, "Command executed, state reset")`

5. **Restructure the message handler** in `setupMessageListener` — change the processing order inside the event handler to:

   a. Extract envelope, phoneNumber, messageId (keep existing code)

   b. **Access control check (NEW — before everything else):**

   ```typescript
   if (!deps.familyWhitelist.isAllowed(phoneNumber)) {
     logger.warn({ phoneNumber }, "Message from unknown sender rejected");
     await sendSignalMessage(
       deps.signalClient,
       phoneNumber,
       "Entschuldigung, ich bin ein privater Familienbot und kann nur mit registrierten Familienmitgliedern kommunizieren.",
     );
     return;
   }
   ```

   c. **Remove the group chat filter** — DELETE the block that checks `envelope.dataMessage?.groupInfo` and returns (lines that say "Skipping group message (not supported in Phase 1)"). Group chats are now supported.

   d. **Non-text message rejection (MODIFY existing check):** Change the existing `if (!text)` block to send a polite rejection instead of silently skipping:

   ```typescript
   if (!text) {
     logger.debug({ messageId, phoneNumber }, "Non-text message rejected");
     await sendSignalMessage(
       deps.signalClient,
       phoneNumber,
       "Ich kann leider nur Textnachrichten verarbeiten.",
     );
     return;
   }
   ```

   e. **Idempotency check** (keep existing)

   f. **Command detection (NEW — before LLM call):**

   ```typescript
   const command = detectCommand(text);
   if (command) {
     await handleCommand(command, phoneNumber, deps);
     return;
   }
   ```

   g. **Personalized greeting (NEW — modify handleIntent's greeting case):**
   In the `handleIntent` function, update the `case "greeting"` to accept the member name. Change the function signature to `handleIntent(intent, deps, memberName?: string)` and update the greeting:

   ```typescript
   case "greeting": {
     const nameGreeting = memberName ? `Hey ${memberName}!` : "Hey!";
     return `${nameGreeting} Ich bin dein Familienkalender-Bot. Schreib mir einfach, was du wissen oder eintragen willst!`;
   }
   ```

   In the main handler, pass the member name: `const memberName = deps.familyWhitelist.getName(phoneNumber);`
   Call: `const response = await handleIntent(intent, deps, memberName);`

   h. **Rest of pipeline** (keep existing: get state, add to history, extract intent, handle intent, send response, add assistant response to history)

The final processing order in the event handler must be:

1. Extract envelope data
2. Access control (whitelist check)
3. Non-text rejection
4. Group chat: allowed (no filter)
5. Idempotency check
6. Mark processed
7. Command detection (help/cancel)
8. Get conversation state
9. Add user message to history
10. Extract intent via LLM
11. Handle intent (with member name for personalization)
12. Send response
13. Add assistant response to history
    </action>
    <verify>

- `grep -c "detectCommand" src/signal/listener.ts` returns at least 2 (definition + usage)
- `grep -c "familyWhitelist" src/signal/listener.ts` returns at least 3 (import type, interface field, usage)
- `grep -c "handleCommand" src/signal/listener.ts` returns at least 2 (definition + usage)
- `grep "groupInfo" src/signal/listener.ts` returns NO lines with "Skipping group" (filter removed)
- `grep "Textnachrichten" src/signal/listener.ts` returns the non-text rejection message
- `grep "abbrechen" src/signal/listener.ts` returns at least 1 (in detectCommand)
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
- Whitelist check rejects unknown senders with polite German message
- Non-text messages rejected with "Ich kann leider nur Textnachrichten verarbeiten."
- "hilfe"/"help"/"?" triggers help text + state reset (no LLM call)
- "abbrechen"/"cancel"/"reset" clears state + confirms (no LLM call)
- Group chat filter removed — bot responds in groups
- Greeting personalized with family member name
  </done>
  </task>

<task type="auto">
  <name>Task 2: Wire family whitelist into application startup</name>
  <files>src/index.ts</files>
  <action>
Modify `src/index.ts`:

1. **Add import:**

   ```typescript
   import {
     loadFamilyConfig,
     FamilyWhitelist,
   } from "./config/family-members.js";
   ```

2. **Load family config** — add after step 1 (validate environment), before step 2 (create service instances):

   ```typescript
   // 2. Load family whitelist
   logger.info("Loading family member configuration...");
   const familyConfig = await loadFamilyConfig();
   const familyWhitelist = new FamilyWhitelist(familyConfig);
   logger.info(
     { memberCount: familyWhitelist.getMemberCount() },
     "Family whitelist loaded",
   );
   ```

3. **Renumber remaining steps** — existing steps 2-6 become 3-7

4. **Pass whitelist to setupMessageListener** — add `familyWhitelist` to the deps object:
   ```typescript
   setupMessageListener({
     signalClient,
     anthropicClient,
     conversationStore,
     idempotencyStore,
     calendarClient,
     familyWhitelist, // NEW
   });
   ```

Important: The family config load must happen BEFORE Signal client connect. If the config is invalid, the app should fail fast at startup (Zod throws), before connecting to Signal.
</action>
<verify>

- `grep "loadFamilyConfig" src/index.ts` returns the import and usage
- `grep "familyWhitelist" src/index.ts` returns at least 3 occurrences (declaration, log, passed to listener)
- `grep "FamilyWhitelist" src/index.ts` returns import and constructor call
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
- Family whitelist loaded and validated at startup before Signal connection
- Invalid config causes fail-fast with clear error message
- Whitelist passed to message listener for access control
- Member count logged at startup
  </done>
  </task>

</tasks>

<verification>
- Unknown phone number sending a message gets rejected (not processed by LLM)
- Whitelisted number sending "hilfe" gets help text without LLM call
- Whitelisted number sending "abbrechen" gets confirmation and state cleared without LLM call
- Whitelisted number sending image/voice note gets non-text rejection
- Whitelisted number sending normal text gets processed through LLM pipeline
- Group chat messages are processed (not filtered out)
- Greeting includes family member name
- Missing family-members.json causes startup failure with clear error
- TypeScript compiles without errors
</verification>

<success_criteria>
Multi-user access control is active, commands bypass LLM, group chats work, and the bot personalizes greetings. Phase 3 success criteria are met:

1. Multiple family members can interact (whitelist-based access)
2. Bot identifies which family member sent each message (phone -> name lookup)
3. User can reset stuck conversations (help/cancel commands)
4. Conversation context times out after 30 min (already implemented in Phase 1)
   </success_criteria>

<output>
After completion, create `.planning/phases/03-multi-user-polish/03-02-SUMMARY.md`
</output>

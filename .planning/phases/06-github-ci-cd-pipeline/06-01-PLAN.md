---
phase: 06-github-ci-cd-pipeline
plan: 1
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - .github/workflows/dependency-review.yml
  - .nvmrc
autonomous: true

must_haves:
  truths:
    - "CI workflow runs format check, typecheck, and tests on every push to main and on PRs"
    - "Dependency review workflow scans PRs that modify package.json or package-lock.json"
    - "Node.js version is pinned via .nvmrc and referenced by workflows"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI pipeline with parallel format-check, typecheck, and test jobs"
      contains: "format:check"
    - path: ".github/workflows/dependency-review.yml"
      provides: "Dependency vulnerability scanning on PRs"
      contains: "dependency-review-action"
    - path: ".nvmrc"
      provides: "Single source of truth for Node.js version"
      contains: "22"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "package.json scripts"
      via: "npm run format:check, npm run build, npm test"
      pattern: "npm run (format:check|build|test)"
    - from: ".github/workflows/ci.yml"
      to: ".nvmrc"
      via: "node-version-file reference"
      pattern: "node-version-file.*\\.nvmrc"
---

<objective>
Create the CI validation pipeline and supporting configuration for the Family Coordinator project.

Purpose: Ensure every push and pull request is validated for formatting (Prettier), type safety (TypeScript), and tests (Vitest) before merging. Add dependency vulnerability scanning on PRs to catch supply chain risks.

Output: Three workflow files (.github/workflows/ci.yml, dependency-review.yml) and .nvmrc for consistent Node.js version pinning.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@package.json
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CI workflow and .nvmrc</name>
  <files>.github/workflows/ci.yml, .nvmrc</files>
  <action>
Create `.nvmrc` at project root containing `22` (matching the Node.js version used on the VPS).

Create `.github/workflows/ci.yml` with three parallel jobs:

1. **format-check** — runs `npm run format:check` (Prettier validation)
2. **typecheck** — runs `npm run build` (TypeScript compiler with noEmit)
3. **test** — runs `npm test` (vitest run)

Important details:

- Trigger on `push` to `main` AND `pull_request` targeting `main`
- Set `permissions: contents: read` (least privilege)
- Each job uses `actions/checkout@v6` and `actions/setup-node@v6` with `node-version-file: ".nvmrc"` and `cache: npm`
- Each job uses `npm ci` for clean dependency install
- Set `timeout-minutes: 5` for format-check and typecheck, `timeout-minutes: 10` for test
- Give each job a descriptive `name:` field for GitHub Actions UI

Do NOT include a lint job — the project has no ESLint configured (only Prettier via format:check).
Do NOT use matrix strategy — single Node.js version matching production.
</action>
<verify>
Validate YAML syntax: `node -e "const yaml = require('yaml'); yaml.parse(require('fs').readFileSync('.github/workflows/ci.yml', 'utf8'))"` or use `cat .github/workflows/ci.yml` to confirm structure.
Confirm .nvmrc contains `22`.
</verify>
<done>
CI workflow file exists at .github/workflows/ci.yml with three parallel jobs (format-check, typecheck, test) triggered on push to main and PRs. .nvmrc exists with Node.js 22 pinned.
</done>
</task>

<task type="auto">
  <name>Task 2: Create dependency review workflow</name>
  <files>.github/workflows/dependency-review.yml</files>
  <action>
Create `.github/workflows/dependency-review.yml` that scans dependency changes in pull requests.

Details:

- Trigger on `pull_request` with `paths` filter for `package.json` and `package-lock.json` only
- Set `permissions: contents: read, pull-requests: write` (needed for PR comments)
- Single job `dependency-review` using `actions/checkout@v6` and `actions/dependency-review-action@v4`
- Configure `fail-on-severity: moderate` to block moderate+ vulnerabilities
- Enable `comment-summary-in-pr: true` for visibility
- Set `timeout-minutes: 5`
  </action>
  <verify>
  Validate YAML syntax and confirm file exists at `.github/workflows/dependency-review.yml`.
  </verify>
  <done>
  Dependency review workflow exists and will scan PRs that modify package.json or package-lock.json for vulnerabilities at moderate+ severity.
  </done>
  </task>

</tasks>

<verification>
- [ ] `.nvmrc` exists at project root containing `22`
- [ ] `.github/workflows/ci.yml` exists with format-check, typecheck, and test jobs
- [ ] `.github/workflows/dependency-review.yml` exists with dependency scanning
- [ ] All workflows use `actions/checkout@v6` and `actions/setup-node@v6`
- [ ] CI workflow references `.nvmrc` via `node-version-file`
- [ ] All workflows have `timeout-minutes` set
- [ ] All workflows have minimal `permissions` set
</verification>

<success_criteria>
Three new files created (.nvmrc, ci.yml, dependency-review.yml) that define the CI validation pipeline. Workflows are syntactically valid YAML and follow GitHub Actions best practices (least privilege permissions, timeout limits, npm ci for clean installs).
</success_criteria>

<output>
After completion, create `.planning/phases/06-github-ci-cd-pipeline/06-01-SUMMARY.md`
</output>

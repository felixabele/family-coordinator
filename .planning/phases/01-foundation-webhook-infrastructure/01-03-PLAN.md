---
phase: 01-foundation-webhook-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/llm/types.ts
  - src/llm/client.ts
  - src/llm/prompts.ts
  - src/llm/intent.ts
  - src/state/types.ts
  - src/state/conversation.ts
autonomous: true

must_haves:
  truths:
    - "Claude extracts structured calendar intent from natural language messages via tool use"
    - "Intent extraction returns typed JSON with intent, entities, confidence, and optional clarification"
    - "System prompt is cached via Anthropic prompt caching for cost reduction"
    - "Conversation state is persisted in PostgreSQL per phone number"
    - "Expired conversation sessions (>30 min inactive) are treated as new conversations"
    - "Message history is limited to last 5 messages to prevent token cost explosion"
  artifacts:
    - path: "src/llm/intent.ts"
      provides: "Claude tool use intent extraction function"
      exports: ["extractIntent"]
    - path: "src/llm/client.ts"
      provides: "Anthropic SDK client initialization"
      exports: ["createAnthropicClient"]
    - path: "src/llm/prompts.ts"
      provides: "System prompt for calendar intent parsing"
      exports: ["CALENDAR_SYSTEM_PROMPT"]
    - path: "src/llm/types.ts"
      provides: "CalendarIntent, IntentType, and entity types"
      exports: ["CalendarIntent", "IntentType"]
    - path: "src/state/conversation.ts"
      provides: "PostgreSQL-backed conversation state CRUD"
      exports: ["ConversationStore"]
    - path: "src/state/types.ts"
      provides: "ConversationState type definition"
      exports: ["ConversationState"]
  key_links:
    - from: "src/llm/intent.ts"
      to: "@anthropic-ai/sdk"
      via: "client.messages.create with tool_choice"
      pattern: "tool_choice.*type.*tool"
    - from: "src/llm/intent.ts"
      to: "src/llm/prompts.ts"
      via: "system prompt with cache_control"
      pattern: "cache_control.*ephemeral"
    - from: "src/state/conversation.ts"
      to: "src/db/pool.ts"
      via: "PostgreSQL queries for conversation CRUD"
      pattern: "pool\\.query"
    - from: "src/state/conversation.ts"
      to: "src/config/constants.ts"
      via: "SESSION_TTL_MS for conversation expiry"
      pattern: "SESSION_TTL|30 minutes"
---

<objective>
Build the Claude LLM integration for intent extraction and the PostgreSQL-backed conversation state management. These are the "brain" and "memory" of the bot.

Purpose: The bot must understand what users want (Claude intent extraction) and remember conversation context across multiple messages (conversation state). Without these, the bot is deaf and amnesiac.
Output: Working intent extraction via Claude tool use and persistent conversation state in PostgreSQL.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-webhook-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-webhook-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Claude intent extraction with tool use and prompt caching</name>
  <files>
    src/llm/types.ts
    src/llm/client.ts
    src/llm/prompts.ts
    src/llm/intent.ts
  </files>
  <action>
    Create src/llm/types.ts:
    - Define `IntentType` as a union: 'create_event' | 'query_events' | 'update_event' | 'delete_event' | 'greeting' | 'help' | 'unclear'
    - Define `CalendarEntities`: `{ title?: string, date?: string, time?: string, duration_minutes?: number }`
    - Define `CalendarIntent`: `{ intent: IntentType, entities: CalendarEntities, confidence: number, clarification_needed?: string }`
    - Create Zod schema for CalendarIntent to validate Claude's tool use output at runtime

    Create src/llm/client.ts:
    - `createAnthropicClient(apiKey: string): Anthropic` -- simple factory that initializes the Anthropic SDK client
    - Export the factory function (not a singleton -- caller provides the API key from validated env)

    Create src/llm/prompts.ts:
    - Define `CALENDAR_SYSTEM_PROMPT` as a detailed string instructing Claude to:
      - Act as a family calendar assistant
      - Parse user messages for calendar intent
      - Extract event details (title, date, time, duration) when present
      - Use the current date/time context provided in the user message for relative date resolution
      - Set confidence score based on how clear the intent is
      - Provide a clarification_needed message when confidence < 0.7 or required entities are missing
      - Handle greetings and help requests gracefully
      - Keep responses family-friendly and concise
    - The prompt should be at least 500 tokens to benefit from prompt caching (Anthropic minimum for caching)
    - Include examples of each intent type in the prompt for better accuracy

    Create src/llm/intent.ts:
    - Define the `calendarIntentTool` object matching Claude tool use schema (see research Pattern 5):
      - name: 'parse_calendar_intent'
      - input_schema with intent (enum), entities (object), confidence (number), clarification_needed (string)
      - All required fields: intent, confidence
    - Implement `extractIntent(client: Anthropic, userMessage: string, conversationHistory?: Array<{role: string, content: string}>): Promise<CalendarIntent>`
      - Call `client.messages.create()` with:
        - model: 'claude-sonnet-4-20250514'
        - max_tokens: 1024
        - system: array with text block containing CALENDAR_SYSTEM_PROMPT and `cache_control: { type: 'ephemeral' }` for prompt caching
        - tools: [calendarIntentTool]
        - tool_choice: `{ type: 'tool', name: 'parse_calendar_intent' }` (forces tool use, guarantees structured output)
        - messages: Build from conversationHistory (last MAX_HISTORY_MESSAGES entries) plus the current user message. Prepend current date/time to user message for relative date resolution.
      - Find the tool_use block in response.content
      - Validate the tool_use input with the Zod schema
      - Log cache metrics from response.usage (cache_read_input_tokens, cache_creation_input_tokens) for monitoring
      - Return the validated CalendarIntent
      - Throw IntentExtractionError if no tool_use block or validation fails
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm all types compile.
    Verify the tool schema has required fields (intent, confidence) and optional fields (entities, clarification_needed).
    Verify cache_control is set on the system prompt.
    Verify tool_choice forces the specific tool (not 'auto').
  </verify>
  <done>
    extractIntent() calls Claude with tool use and returns a validated CalendarIntent.
    System prompt uses cache_control for prompt caching (90% cost reduction on cache hits).
    Tool choice forces structured output (no free-text parsing needed).
    Conversation history is limited to MAX_HISTORY_MESSAGES (5) to control costs.
    CalendarIntent output is validated with Zod before returning.
  </done>
</task>

<task type="auto">
  <name>Task 2: PostgreSQL conversation state management</name>
  <files>
    src/state/types.ts
    src/state/conversation.ts
  </files>
  <action>
    Create src/state/types.ts:
    - Define `ConversationState` interface:
      - phoneNumber: string
      - currentIntent: string | null (the active intent being refined across messages)
      - pendingEntities: Record<string, unknown> (partial entities collected across messages)
      - messageHistory: Array<{ role: 'user' | 'assistant', content: string }> (recent message history for LLM context)
      - lastMessageAt: Date
    - Define `MessageHistoryEntry`: `{ role: 'user' | 'assistant', content: string }`

    Create src/state/conversation.ts:
    - `ConversationStore` class with constructor accepting pg.Pool
    - `getState(phoneNumber: string): Promise<ConversationState | null>`
      - Query conversations table WHERE phone_number = $1 AND last_message_at > NOW() - INTERVAL '30 minutes'
      - If no rows (expired or nonexistent), return null (caller treats as new conversation)
      - Map database row to ConversationState (parse JSONB fields)
    - `saveState(state: ConversationState): Promise<void>`
      - UPSERT using INSERT ... ON CONFLICT (phone_number) DO UPDATE
      - Store pendingEntities and messageHistory as JSONB
      - Always set last_message_at to NOW()
    - `clearState(phoneNumber: string): Promise<void>`
      - DELETE FROM conversations WHERE phone_number = $1
      - Used when conversation completes or user sends reset command
    - `addToHistory(phoneNumber: string, role: 'user' | 'assistant', content: string): Promise<void>`
      - Get current state, append to messageHistory
      - Trim to MAX_HISTORY_MESSAGES (from constants) -- keep only the latest N entries
      - Save updated state
    - All methods use parameterized queries ($1, $2, ...) to prevent SQL injection
    - Log database operations at debug level via logger
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm all types compile.
    Verify ConversationStore methods use parameterized queries (no string interpolation in SQL).
    Verify the 30-minute TTL is applied in the SELECT query.
    Verify messageHistory is trimmed to MAX_HISTORY_MESSAGES in addToHistory.
  </verify>
  <done>
    ConversationStore provides getState, saveState, clearState, and addToHistory.
    Expired sessions (>30 min) return null from getState.
    Message history is automatically trimmed to 5 entries.
    All database queries use parameterized values.
    JSONB fields are correctly serialized/deserialized.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- Claude tool definition has required intent + confidence fields
- Prompt caching cache_control is set on system prompt
- Conversation state queries use 30-minute TTL
- Message history is trimmed to MAX_HISTORY_MESSAGES
- All SQL uses parameterized queries
</verification>

<success_criteria>
- extractIntent() accepts natural language and returns structured CalendarIntent via Claude tool use
- System prompt is cached for cost efficiency
- Conversation state persists across messages for the same phone number
- Sessions expire after 30 minutes of inactivity
- Message history is bounded to prevent token cost explosion
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-webhook-infrastructure/01-03-SUMMARY.md`
</output>

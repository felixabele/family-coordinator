---
phase: 01-deployment
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified: []
autonomous: false

user_setup:
  - service: VPS Provider
    why: "Signal bot requires always-on VPS for persistent daemon"
    env_vars: []
    dashboard_config:
      - task: "Provision VPS with Docker installed"
        location: "DigitalOcean, Hetzner, or Scaleway dashboard"
  - service: Signal Registration
    why: "signal-cli must be registered with a dedicated phone number on the VPS"
    env_vars:
      - name: SIGNAL_PHONE_NUMBER
        source: "Dedicated phone number for bot (cannot be shared with personal Signal)"
    dashboard_config:
      - task: "Register signal-cli with phone number on VPS"
        location: "VPS terminal: signal-cli -u +NUMBER register / signal-cli -u +NUMBER verify CODE"

must_haves:
  truths:
    - "Application runs on VPS as Docker Compose stack"
    - "Health check endpoint responds with healthy status"
    - "Signal bot receives and responds to messages"
    - "Database persists across container restarts"
    - "Automated backups are running on schedule"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete deployment on a production VPS. User provisions server, transfers secrets, and confirms the bot is operational.

Purpose: Validate that all deployment artifacts work together in a real production environment.
Output: Running production deployment confirmed by user.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-deployment/01-01-SUMMARY.md
@.planning/phases/01-deployment/01-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Provision VPS and deploy application</name>
  <action>
  The user needs to:

1. **Provision a VPS** (DigitalOcean Frankfurt, Hetzner, or similar):
   - Ubuntu 22.04+ or Debian 12+
   - Minimum: 1 vCPU, 1 GB RAM, 25 GB SSD
   - Install Docker and Docker Compose

2. **Clone repository to VPS:**

   ```bash
   git clone <repo-url> /opt/family-coordinator
   cd /opt/family-coordinator
   ```

3. **Create secrets directory and files:**

   ```bash
   mkdir -p secrets data/signal-cli data/postgres data/backups logs
   # Create each secret file:
   echo "+49YOURNUMBER" > secrets/signal-phone.txt
   echo "sk-ant-your-key" > secrets/anthropic-api-key.txt
   cp /path/to/service-account.json secrets/google-service-account.json
   echo "your-calendar-id@group.calendar.google.com" > secrets/google-calendar-id.txt
   echo "postgresql://postgres:YOURPASSWORD@postgres:5432/family_coordinator" > secrets/database-url.txt
   echo "YOURPASSWORD" > secrets/db-password.txt
   chmod 600 secrets/*
   ```

4. **Create family-members.json:**

   ```bash
   cp family-members.example.json family-members.json
   # Edit with actual family member phone numbers and names
   ```

5. **Register signal-cli** (if not already registered):

   ```bash
   # Install signal-cli on VPS
   # Register with phone number
   signal-cli -u +49YOURNUMBER register
   signal-cli -u +49YOURNUMBER verify CODE
   # Set registration lock PIN
   signal-cli -u +49YOURNUMBER setPin YOUR_PIN
   # Copy signal-cli data to mounted volume
   cp -r ~/.local/share/signal-cli/* data/signal-cli/
   ```

6. **Deploy:**
   `bash
chmod +x scripts/deploy.sh
./scripts/deploy.sh deploy
`
   </action>
   <resume-signal>Type "deployed" when the VPS is running, or describe any issues encountered.</resume-signal>
   </task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify production deployment is operational</name>
  <action>
  Verify the complete production deployment of Family Coordinator Signal bot on VPS with Docker Compose, PostgreSQL, automated backups, and health monitoring.

Steps to verify:

1. **Check service status:** Run `./scripts/deploy.sh status` — all three services (app, postgres, pg-backup) should show "Up" and "healthy".

2. **Check health endpoint:** Run `curl http://localhost:3000/health` — should return `{"status":"healthy","checks":{"database":true},...}`

3. **Send a test message:** Send "Hilfe" to the bot's Signal number from a whitelisted family member's phone. Bot should respond with the help text listing available commands.

4. **Test calendar operation:** Send "Was steht morgen an?" to the bot. Bot should respond with tomorrow's calendar events (or that the day is free).

5. **Verify logs:** Run `./scripts/deploy.sh logs` — should show structured JSON logs with message processing activity.

6. **Verify backups directory:** Run `ls -la data/backups/` — directory should exist (first automated backup will run at the scheduled time).
   </action>
   <verify>All six verification steps pass without errors.</verify>
   <done>Production deployment confirmed operational: services healthy, bot responding, logs flowing, backups configured.</done>
   <resume-signal>Type "approved" if all checks pass, or describe any issues.</resume-signal>
   </task>

</tasks>

<verification>
- All Docker services running and healthy
- Health endpoint returns healthy status with database connectivity
- Signal bot receives and responds to messages from whitelisted family members
- Database data persists across container restart (`docker compose -f docker-compose.production.yml restart app`)
- Logs are written to logs/ directory in JSON format
</verification>

<success_criteria>
Family Coordinator Signal bot is running in production on a VPS, responding to family messages, managing the shared Google Calendar, and automatically backing up the database. The deployment is complete and the bot is operational.
</success_criteria>

<output>
After completion, create `.planning/phases/01-deployment/01-03-SUMMARY.md`
</output>

---
phase: 01-foundation-webhook-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - eslint.config.mjs
  - .env.example
  - .gitignore
  - src/config/env.ts
  - src/config/constants.ts
  - src/utils/logger.ts
  - src/utils/errors.ts
  - src/db/pool.ts
  - src/db/migrations/001_init.sql
  - src/db/migrate.ts
autonomous: true
user_setup:
  - service: postgresql
    why: "Database for conversation state and message logging"
    env_vars:
      - name: DATABASE_URL
        source: "Local PostgreSQL instance or managed service (e.g., Railway, Render). Format: postgresql://user:password@host:port/dbname"
  - service: redis
    why: "Required by BullMQ for async job processing and idempotency checks"
    env_vars:
      - name: REDIS_URL
        source: "Local Redis instance (Docker: docker run -d -p 6379:6379 redis) or managed Redis service. Format: redis://localhost:6379"

must_haves:
  truths:
    - "Project initializes with TypeScript, ESM modules, and all Phase 1 dependencies installed"
    - "Environment variables are validated at startup with clear error messages for missing/invalid vars"
    - "PostgreSQL connection pool is created and reusable across the application"
    - "Database schema for conversations and message_log tables exists and can be applied"
    - "Structured logging is configured with pino (pretty in dev, JSON in production)"
  artifacts:
    - path: "package.json"
      provides: "Project metadata, dependencies, scripts"
      contains: "fastify"
    - path: "tsconfig.json"
      provides: "TypeScript configuration for ESM + Node.js 22"
      contains: "NodeNext"
    - path: "src/config/env.ts"
      provides: "Zod-validated environment variables with TypeScript types"
      exports: ["validateEnv", "Env"]
    - path: "src/db/pool.ts"
      provides: "PostgreSQL connection pool singleton"
      exports: ["pool", "closePool"]
    - path: "src/db/migrations/001_init.sql"
      provides: "conversations and message_log tables"
      contains: "CREATE TABLE"
    - path: "src/utils/logger.ts"
      provides: "Pino logger instance"
      exports: ["logger"]
  key_links:
    - from: "src/config/env.ts"
      to: "process.env"
      via: "Zod schema parse at startup"
      pattern: "envSchema\\.safeParse"
    - from: "src/db/pool.ts"
      to: "src/config/env.ts"
      via: "DATABASE_URL from validated env"
      pattern: "DATABASE_URL"
---

<objective>
Initialize the project scaffold with TypeScript, install all Phase 1 dependencies, configure environment validation, set up PostgreSQL connection pool, create database migration, and configure structured logging.

Purpose: Every subsequent plan depends on project structure, validated config, database access, and logging. This is the foundation layer.
Output: Runnable TypeScript project with validated config, database pool, migration script, and structured logging.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-webhook-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project scaffold with TypeScript, ESM, and all dependencies</name>
  <files>
    package.json
    tsconfig.json
    eslint.config.mjs
    .env.example
    .gitignore
  </files>
  <action>
    Initialize the project with `npm init -y`. Set `"type": "module"` in package.json for ESM.

    Install core dependencies:
    ```
    npm install fastify @fastify/rate-limit @anthropic-ai/sdk bullmq ioredis pg pino pino-pretty zod date-fns
    ```

    Install dev dependencies:
    ```
    npm install -D typescript @types/node @types/pg tsx vitest
    ```

    Configure package.json scripts:
    - `"dev": "tsx watch src/index.ts"` (hot-reload development)
    - `"start": "node --experimental-strip-types src/index.ts"` (production using Node 22 native TS stripping)
    - `"build": "tsc"` (type checking only, not for production build since we use native stripping)
    - `"migrate": "tsx src/db/migrate.ts"` (run database migrations)
    - `"test": "vitest run"` (run tests)

    Create tsconfig.json:
    - `"target": "ES2023"`, `"module": "NodeNext"`, `"moduleResolution": "NodeNext"`
    - `"strict": true`, `"skipLibCheck": true`
    - `"outDir": "./dist"`, `"rootDir": "./src"`
    - `"resolveJsonModule": true`, `"isolatedModules": true`
    - `"noEmit": true` (we use Node 22 native TS stripping, not tsc for output)

    Create eslint.config.mjs with ESLint v9 flat config using typescript-eslint.

    Create .env.example listing all required env vars with placeholder values and comments explaining where to get each one:
    - WHATSAPP_PHONE_NUMBER_ID, WHATSAPP_ACCESS_TOKEN, WHATSAPP_WEBHOOK_VERIFY_TOKEN, WHATSAPP_APP_SECRET
    - ANTHROPIC_API_KEY
    - DATABASE_URL
    - REDIS_URL
    - PORT, NODE_ENV, LOG_LEVEL

    Create .gitignore with: node_modules, dist, .env, *.log, .DS_Store.
  </action>
  <verify>
    Run `npx tsc --noEmit` and confirm no TypeScript errors (will succeed with empty src).
    Run `npm test` to confirm vitest is configured (may show "no tests" which is fine).
    Verify `node_modules/` exists and key packages are installed: `ls node_modules/fastify node_modules/bullmq node_modules/@anthropic-ai`.
  </verify>
  <done>
    package.json has type:module, all dependencies installed, scripts defined.
    tsconfig.json configured for ESM + Node 22.
    .env.example documents all required environment variables.
    .gitignore excludes node_modules, dist, .env.
  </done>
</task>

<task type="auto">
  <name>Task 2: Environment validation, database pool, migration, and logging</name>
  <files>
    src/config/env.ts
    src/config/constants.ts
    src/utils/logger.ts
    src/utils/errors.ts
    src/db/pool.ts
    src/db/migrations/001_init.sql
    src/db/migrate.ts
  </files>
  <action>
    Create src/config/env.ts:
    - Define Zod schema for all env vars (see research Pattern: Environment Variable Validation)
    - WHATSAPP_PHONE_NUMBER_ID: z.string().min(1)
    - WHATSAPP_ACCESS_TOKEN: z.string().min(1)
    - WHATSAPP_WEBHOOK_VERIFY_TOKEN: z.string().min(1)
    - WHATSAPP_APP_SECRET: z.string().min(1)
    - ANTHROPIC_API_KEY: z.string().startsWith('sk-')
    - DATABASE_URL: z.string().min(1) (not .url() since postgres:// may not pass URL validation)
    - REDIS_URL: z.string().default('redis://localhost:6379')
    - PORT: z.coerce.number().default(3000)
    - NODE_ENV: z.enum(['development', 'production', 'test']).default('development')
    - LOG_LEVEL: z.enum(['fatal', 'error', 'warn', 'info', 'debug', 'trace']).default('info')
    - Export `validateEnv()` function and `Env` type
    - On validation failure, log the specific missing/invalid fields and call `process.exit(1)`

    Create src/config/constants.ts:
    - SESSION_TTL_MS = 30 * 60 * 1000 (30 minutes)
    - PROCESSED_MESSAGE_TTL = 7 * 24 * 60 * 60 (7 days in seconds, for Redis)
    - MAX_HISTORY_MESSAGES = 5 (messages sent to LLM context)
    - WHATSAPP_API_VERSION = 'v21.0'
    - QUEUE_NAME = 'whatsapp-messages'
    - MAX_CONCURRENT_JOBS = 3

    Create src/utils/logger.ts:
    - Create pino logger instance
    - Use pino-pretty transport in development (NODE_ENV !== 'production')
    - Use default JSON transport in production
    - Accept log level from config
    - Export singleton `logger`

    Create src/utils/errors.ts:
    - Create custom error classes: `WebhookValidationError`, `WhatsAppApiError`, `IntentExtractionError`
    - Each extends Error with a `code` property for structured logging

    Create src/db/pool.ts:
    - Create pg.Pool with DATABASE_URL from validated env
    - Set max: 10 connections
    - Export `pool` singleton and `closePool()` function for graceful shutdown
    - Log pool connection events (connect, error) via logger

    Create src/db/migrations/001_init.sql:
    - conversations table with: phone_number (PK, VARCHAR(20)), current_intent (VARCHAR(50)), pending_entities (JSONB), message_history (JSONB), created_at (TIMESTAMPTZ), last_message_at (TIMESTAMPTZ)
    - Index on last_message_at for TTL queries
    - message_log table with: id (SERIAL PK), whatsapp_message_id (VARCHAR(100) UNIQUE), phone_number (VARCHAR(20)), direction (VARCHAR(10)), message_type (VARCHAR(20)), content (TEXT), intent (VARCHAR(50)), processed_at (TIMESTAMPTZ)
    - Indexes on phone_number and whatsapp_message_id

    Create src/db/migrate.ts:
    - Simple migration runner that reads SQL files from migrations/ directory
    - Executes them in order against the database
    - Tracks applied migrations (can use a simple migrations table or just run idempotently with IF NOT EXISTS)
    - Invokable via `npm run migrate`
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm all TypeScript compiles.
    Verify imports work: `node --experimental-strip-types -e "import { validateEnv } from './src/config/env.ts'; console.log('env module OK')"` (will fail on missing env vars but should import cleanly).
    Check that the SQL migration file contains both CREATE TABLE statements.
  </verify>
  <done>
    src/config/env.ts exports validateEnv() that validates all env vars via Zod and exits on failure.
    src/config/constants.ts exports all application constants.
    src/utils/logger.ts exports a pino logger with pretty printing in dev.
    src/utils/errors.ts exports custom error classes.
    src/db/pool.ts exports a PostgreSQL connection pool.
    src/db/migrations/001_init.sql creates conversations and message_log tables.
    src/db/migrate.ts can run migrations via npm run migrate.
    All files compile with no TypeScript errors.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- All files exist at their specified paths
- package.json has "type": "module" and all required dependencies
- .env.example lists all required environment variables
- SQL migration creates both tables with correct schemas
</verification>

<success_criteria>
- TypeScript project compiles cleanly with ESM module resolution
- All Phase 1 dependencies are installed (fastify, bullmq, @anthropic-ai/sdk, pg, ioredis, zod, pino)
- Environment validation catches missing/invalid variables at startup
- Database migration SQL is ready to apply
- Logger produces structured output
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-webhook-infrastructure/01-01-SUMMARY.md`
</output>

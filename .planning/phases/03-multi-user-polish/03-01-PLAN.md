---
phase: 03-multi-user-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/family-members.ts
  - family-members.example.json
  - package.json
autonomous: true

must_haves:
  truths:
    - "Family config file is validated at load time with Zod and libphonenumber-js"
    - "Phone numbers are normalized to E.164 before storage in whitelist"
    - "FamilyWhitelist provides O(1) lookup by phone number returning member name"
    - "Invalid config (missing fields, bad phone format) causes clear error at startup"
  artifacts:
    - path: "src/config/family-members.ts"
      provides: "Family whitelist config loading, validation, and lookup"
      exports:
        ["loadFamilyConfig", "FamilyWhitelist", "FamilyMember", "FamilyConfig"]
    - path: "family-members.example.json"
      provides: "Example config file showing expected format"
      contains: "members"
  key_links:
    - from: "src/config/family-members.ts"
      to: "libphonenumber-js"
      via: "parsePhoneNumber for E.164 validation"
      pattern: "parsePhoneNumber"
    - from: "src/config/family-members.ts"
      to: "zod"
      via: "schema validation of JSON config"
      pattern: "z\\.object"
---

<objective>
Create the family member whitelist configuration module with Zod-validated JSON loading and in-memory phone number lookup.

Purpose: Foundation for multi-user access control — the bot needs to know which phone numbers belong to family members and what their names are.
Output: `src/config/family-members.ts` module and `family-members.example.json` template.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-user-polish/03-RESEARCH.md
@src/config/env.ts
@src/config/constants.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install libphonenumber-js and create family config module</name>
  <files>package.json, src/config/family-members.ts, family-members.example.json</files>
  <action>
1. Install libphonenumber-js:
   ```bash
   npm install libphonenumber-js@1.11.14
   ```

2. Create `src/config/family-members.ts` with:
   - Import `z` from `zod`, `readFile` from `fs/promises`, `parsePhoneNumber` from `libphonenumber-js`

   - `FamilyMemberSchema`: Zod object with:
     - `phone`: z.string() with `.transform()` that parses via `parsePhoneNumber()`, validates `.isValid()`, and returns `.format("E.164")`. Throw descriptive error if invalid.
     - `name`: z.string().min(1).max(50)

   - `FamilyConfigSchema`: z.object with `members` array of FamilyMemberSchema, `.min(1)` (at least one family member)

   - Export types: `FamilyMember = z.infer<typeof FamilyMemberSchema>`, `FamilyConfig = z.infer<typeof FamilyConfigSchema>`

   - Export `async function loadFamilyConfig(path: string = "./family-members.json"): Promise<FamilyConfig>`:
     - Read file with `readFile(path, "utf-8")`
     - Parse JSON
     - Validate with `FamilyConfigSchema.parse(json)`
     - Wrap errors: if file not found, throw clear error mentioning the expected path. If Zod validation fails, let ZodError propagate (it has good messages).
     - Return validated config

   - Export `class FamilyWhitelist`:
     - Private `members: Map<string, string>` (phone -> name)
     - Constructor takes `FamilyConfig`, populates Map from `config.members.map(m => [m.phone, m.name])`
     - `isAllowed(phoneNumber: string): boolean` — Map.has()
     - `getName(phoneNumber: string): string | undefined` — Map.get()
     - `getMemberCount(): number` — Map.size

3. Create `family-members.example.json`:
   ```json
   {
     "members": [
       { "phone": "+491234567890", "name": "Papa" },
       { "phone": "+490987654321", "name": "Mama" }
     ]
   }
   ```

Important: Follow existing code patterns — use the same JSDoc style as `src/config/env.ts`, export types alongside functions, use descriptive error messages in German where user-facing (but English for developer-facing errors since existing codebase uses English for code comments/errors).
</action>
<verify>
Run `npx tsx -e "import { loadFamilyConfig, FamilyWhitelist } from './src/config/family-members.js'; const config = await loadFamilyConfig('./family-members.example.json'); const wl = new FamilyWhitelist(config); console.log('members:', wl.getMemberCount()); console.log('allowed:', wl.isAllowed('+491234567890')); console.log('name:', wl.getName('+491234567890')); console.log('unknown:', wl.isAllowed('+19999999999'));"` prints:

- members: 2
- allowed: true
- name: Papa
- unknown: false

Also verify libphonenumber-js is in package.json dependencies.
</verify>
<done>

- FamilyWhitelist loads and validates JSON config with Zod + libphonenumber-js
- Phone numbers normalized to E.164 format via transform
- Invalid config throws clear errors (missing members, bad phone format)
- O(1) lookup by phone number returns member name
- Example config file exists with realistic German phone numbers
  </done>
  </task>

</tasks>

<verification>
- `src/config/family-members.ts` exports loadFamilyConfig, FamilyWhitelist, FamilyMember, FamilyConfig
- `family-members.example.json` is valid JSON with members array
- libphonenumber-js is in package.json dependencies
- Phone number normalization handles spaces/dashes (e.g., "+49 123 456 7890" -> "+491234567890")
- Empty members array throws validation error
- Missing phone or name field throws validation error
</verification>

<success_criteria>
Family config module loads, validates, and provides fast phone number lookup. Ready for integration into message listener (Plan 02).
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-user-polish/03-01-SUMMARY.md`
</output>

---
phase: 02-calendar-crud
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/config/env.ts
  - .env.example
  - src/calendar/types.ts
  - src/calendar/client.ts
  - src/calendar/timezone.ts
  - src/calendar/operations.ts
autonomous: true
user_setup:
  - service: google-calendar
    why: "Google Calendar API access via service account"
    env_vars:
      - name: GOOGLE_SERVICE_ACCOUNT_KEY_FILE
        source: "Path to the Google Cloud service account JSON key file on disk"
      - name: GOOGLE_CALENDAR_ID
        source: "Google Calendar Settings -> Calendar ID (looks like xxx@group.calendar.google.com)"
    dashboard_config:
      - task: "Ensure calendar is shared with the service account email"
        location: "Google Calendar -> Settings -> Share with specific people -> Add service account email with 'Make changes to events' permission"

must_haves:
  truths:
    - "Calendar client authenticates with Google Calendar API using service account credentials"
    - "Calendar operations can list events for a specific date range"
    - "Calendar operations can create events with timezone-aware start/end times"
    - "Calendar operations can update existing events by ID"
    - "Calendar operations can delete events by ID"
    - "Timezone utilities correctly infer date when only time is provided"
    - "Default event duration is 1 hour when no end time specified"
  artifacts:
    - path: "src/calendar/types.ts"
      provides: "Calendar domain types for events and operation results"
    - path: "src/calendar/client.ts"
      provides: "Google Calendar API client with service account auth"
      exports: ["createCalendarClient", "CalendarClient"]
    - path: "src/calendar/timezone.ts"
      provides: "Timezone-aware date/time utilities for Europe/Berlin"
      exports: ["inferEventDate", "createEventDateTime", "formatEventTime"]
    - path: "src/calendar/operations.ts"
      provides: "CRUD operations for Google Calendar events"
      exports:
        [
          "listEvents",
          "createEvent",
          "updateEvent",
          "deleteEvent",
          "findEvents",
        ]
  key_links:
    - from: "src/calendar/client.ts"
      to: "googleapis"
      via: "GoogleAuth with service account key file"
      pattern: "google\\.auth\\.GoogleAuth"
    - from: "src/calendar/operations.ts"
      to: "src/calendar/client.ts"
      via: "CalendarClient parameter"
      pattern: "CalendarClient"
    - from: "src/calendar/timezone.ts"
      to: "luxon"
      via: "DateTime with Europe/Berlin zone"
      pattern: "DateTime.*zone.*Europe/Berlin"
---

<objective>
Build the complete Google Calendar integration module: authenticated API client, timezone utilities, and all CRUD operations (list, create, update, delete).

Purpose: This is the calendar foundation that Phase 2's pipeline integration depends on. All calendar operations are self-contained in `src/calendar/` and can be tested independently before wiring into the Signal message pipeline.

Output: Complete `src/calendar/` module with client, types, timezone utilities, and CRUD operations ready for integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-calendar-crud/02-RESEARCH.md
@.planning/phases/02-calendar-crud/02-CONTEXT.md
@src/config/env.ts
@package.json
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add Google Calendar environment configuration</name>
  <files>
    package.json
    src/config/env.ts
    .env.example
    src/calendar/types.ts
    src/calendar/client.ts
  </files>
  <action>
1. Install googleapis and luxon:
   ```bash
   npm install googleapis@171.4.0 luxon@3.7.2
   npm install -D @types/luxon
   ```

2. Update `src/config/env.ts` — add these env vars to the Zod schema:
   - `GOOGLE_SERVICE_ACCOUNT_KEY_FILE`: z.string().min(1) — path to JSON key file
   - `GOOGLE_CALENDAR_ID`: z.string().min(1) — calendar ID
   - `FAMILY_TIMEZONE`: z.string().default("Europe/Berlin") — IANA timezone identifier

3. Update `.env.example` — add the three new env vars with descriptive comments:

   ```
   # Google Calendar
   # Path to service account JSON key file
   GOOGLE_SERVICE_ACCOUNT_KEY_FILE=./service-account-key.json
   # Calendar ID (find in Calendar Settings -> Calendar ID)
   GOOGLE_CALENDAR_ID=your-calendar-id@group.calendar.google.com
   # Family timezone (IANA format)
   FAMILY_TIMEZONE=Europe/Berlin
   ```

4. Create `src/calendar/types.ts` — domain types:
   - `CalendarEvent` interface: id, summary, startTime (ISO string), endTime (ISO string), isAllDay (boolean), description? (string)
   - `CreateEventInput` interface: summary (string), date (string YYYY-MM-DD), time (string HH:mm), durationMinutes? (number, default 60), description? (string)
   - `UpdateEventInput` interface: eventId (string), summary? (string), date? (string), time? (string), durationMinutes? (number)
   - `EventSearchResult` type: { event: CalendarEvent } | { candidates: CalendarEvent[] } | { notFound: true }
   - `CalendarError` class extending Error with `code` property (string: "NOT_FOUND", "PERMISSION_DENIED", "RATE_LIMITED", "API_ERROR")

5. Create `src/calendar/client.ts`:
   - Import `google` from `googleapis`
   - Export `CalendarClient` interface: `{ calendar: calendar_v3.Calendar; calendarId: string; timezone: string }`
   - Export `createCalendarClient(keyFilePath: string, calendarId: string, timezone: string): CalendarClient`
   - Use `new google.auth.GoogleAuth({ keyFile: keyFilePath, scopes: ['https://www.googleapis.com/auth/calendar'] })`
   - Create calendar client with `google.calendar({ version: 'v3', auth })`
   - Configure retryConfig on the calendar client: retry 3, statusCodesToRetry [[429,429],[500,599]], httpMethodsToRetry ['GET','POST','PATCH','DELETE']
   - Return `{ calendar, calendarId, timezone }`
     </action>
     <verify>
     Run `npx tsc --noEmit` — no type errors.
     Verify `node --experimental-strip-types -e "import { createCalendarClient } from './src/calendar/client.ts'; console.log('OK')"` loads without errors.
     Verify `grep 'GOOGLE_SERVICE_ACCOUNT_KEY_FILE\|GOOGLE_CALENDAR_ID\|FAMILY_TIMEZONE' src/config/env.ts` shows all three env vars.
     </verify>
     <done>
     googleapis and luxon installed. Environment schema validates Google Calendar config. CalendarClient factory creates authenticated client with retry config. Domain types defined for all calendar operations.
     </done>
     </task>

<task type="auto">
  <name>Task 2: Create timezone utilities and calendar CRUD operations</name>
  <files>
    src/calendar/timezone.ts
    src/calendar/operations.ts
  </files>
  <action>
1. Create `src/calendar/timezone.ts` — timezone-aware date/time utilities using Luxon:

**`inferEventDate(time: string, timezone: string): string`**

- Takes time in "HH:mm" format and timezone string
- Gets current time in the given timezone using `DateTime.now().setZone(timezone)`
- If the time hasn't passed today, return today's date as YYYY-MM-DD
- If the time has passed today, return tomorrow's date as YYYY-MM-DD
- Per user decision: "assume today if time hasn't passed, otherwise tomorrow"

**`createEventDateTime(date: string, time: string, timezone: string): { dateTime: string; timeZone: string }`**

- Takes date "YYYY-MM-DD", time "HH:mm", timezone string
- Creates Luxon DateTime: `DateTime.fromFormat(\`${date} ${time}\`, 'yyyy-MM-dd HH:mm', { zone: timezone })`
- Returns `{ dateTime: dt.toISO(), timeZone: timezone }`
- CRITICAL: Always include both dateTime AND timeZone to handle DST correctly (per research pitfall #1)

**`createEventEndDateTime(date: string, time: string, durationMinutes: number, timezone: string): { dateTime: string; timeZone: string }`**

- Same as createEventDateTime but adds durationMinutes to the start time
- Default duration: 60 minutes (per user decision)

**`formatEventTime(isoString: string, timezone: string): string`**

- Takes ISO datetime string, converts to timezone, returns "HH:mm" format
- Used for compact event display

**`formatEventDate(isoString: string, timezone: string): string`**

- Takes ISO datetime string, returns localized German date: "Di, 14. Feb"
- Use `dt.setLocale('de').toFormat('ccc, d. MMM')`

**`formatDayName(date: string, timezone: string): string`**

- Takes YYYY-MM-DD, returns German day name: "Dienstag"
- Use for empty state messages: "Dienstag ist frei!"

2. Create `src/calendar/operations.ts` — CRUD operations using CalendarClient:

   Import CalendarClient, types from types.ts, timezone utilities, logger.

   **`listEvents(client: CalendarClient, date: string): Promise<CalendarEvent[]>`**
   - Takes YYYY-MM-DD date string
   - Compute dayStart (start of day in client.timezone) and dayEnd (end of day)
   - Call `client.calendar.events.list({ calendarId: client.calendarId, timeMin: dayStart.toISO(), timeMax: dayEnd.toISO(), singleEvents: true, orderBy: 'startTime' })`
   - Map response.data.items to CalendarEvent[] (handle empty items array)
   - Map each Google event: extract id, summary, start.dateTime or start.date (all-day), end.dateTime or end.date, isAllDay flag
   - Catch errors: 403 -> CalendarError("PERMISSION_DENIED"), 429 -> CalendarError("RATE_LIMITED"), others -> CalendarError("API_ERROR")

   **`findEvents(client: CalendarClient, date: string, titleHint?: string): Promise<EventSearchResult>`**
   - List events for the given date, optionally filter by titleHint using `q` parameter on events.list
   - If 0 results: return `{ notFound: true }`
   - If 1 result: return `{ event: result }`
   - If 2+ results: return `{ candidates: results }`
   - This implements the disambiguation pattern (per user decision: "list matching events with numbers and ask which one")

   **`createEvent(client: CalendarClient, input: CreateEventInput): Promise<CalendarEvent>`**
   - Build Google Calendar event object with summary, start (dateTime + timeZone), end (dateTime + timeZone)
   - Use createEventDateTime for start, createEventEndDateTime for end
   - Default durationMinutes to 60 if not provided (per user decision)
   - Call `client.calendar.events.insert({ calendarId: client.calendarId, requestBody: event })`
   - Map response.data to CalendarEvent and return
   - Include description if provided in input

   **`updateEvent(client: CalendarClient, eventId: string, input: UpdateEventInput): Promise<CalendarEvent>`**
   - Build partial Google Calendar event from input (only set fields that are provided)
   - If time or date changes, recalculate start/end using timezone utilities
   - If only time changes without date, fetch the existing event first to get its current date
   - Call `client.calendar.events.patch({ calendarId, eventId, requestBody: updates })`
   - Map response.data to CalendarEvent and return

   **`deleteEvent(client: CalendarClient, eventId: string): Promise<void>`**
   - Call `client.calendar.events.delete({ calendarId: client.calendarId, eventId })`
   - No return value (per user decision: "Deletes execute immediately")
   - Catch 404/410 -> CalendarError("NOT_FOUND"), other errors -> CalendarError("API_ERROR")

   All operations should log their actions using Pino logger with relevant context (operation name, eventId, calendarId).
   </action>
   <verify>
   Run `npx tsc --noEmit` — no type errors.
   Verify exports: `grep -c 'export' src/calendar/operations.ts` shows 5 exports (listEvents, findEvents, createEvent, updateEvent, deleteEvent).
   Verify exports: `grep -c 'export' src/calendar/timezone.ts` shows 5+ exports.
   Verify timezone utilities use Luxon: `grep 'DateTime' src/calendar/timezone.ts` shows DateTime usage.
   Verify IANA timezone used (not UTC offsets): `grep 'timeZone' src/calendar/operations.ts` shows timeZone field in event objects.
   </verify>
   <done>
   Timezone utilities correctly handle Europe/Berlin with DST-safe IANA identifiers. All five CRUD operations implemented with proper error handling and CalendarError classification. Date inference works per user decision (today if time not passed, tomorrow if passed). Default 1-hour duration applied when no end time specified.
   </done>
   </task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. All `src/calendar/` files exist: client.ts, types.ts, timezone.ts, operations.ts
3. `grep 'GOOGLE_SERVICE_ACCOUNT_KEY_FILE' src/config/env.ts` confirms env var added
4. `grep 'googleapis' package.json` confirms dependency installed
5. `grep 'luxon' package.json` confirms dependency installed
6. No UTC offset patterns in operations.ts (only IANA timezone identifiers)
</verification>

<success_criteria>

- Google Calendar client authenticates via service account and provides typed API access
- All CRUD operations (list, find, create, update, delete) are implemented and type-safe
- Timezone utilities use Luxon with Europe/Berlin default, handle DST correctly
- Environment validation fails fast if Google Calendar config is missing
- Error handling classifies API errors (NOT_FOUND, PERMISSION_DENIED, RATE_LIMITED, API_ERROR)
- Zero TypeScript compilation errors
  </success_criteria>

<output>
After completion, create `.planning/phases/02-calendar-crud/02-01-SUMMARY.md`
</output>

---
phase: 06-github-ci-cd-pipeline
plan: 2
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/deploy.yml
  - scripts/deploy.sh
autonomous: true

user_setup:
  - service: GitHub Secrets
    why: "SSH credentials for VPS deployment"
    env_vars:
      - name: VPS_HOST
        source: "GitHub repo → Settings → Secrets and variables → Actions → New repository secret (value: VPS IP address or hostname)"
      - name: VPS_USERNAME
        source: "GitHub repo → Settings → Secrets and variables → Actions → New repository secret (value: SSH username, e.g. root or deploy)"
      - name: VPS_PORT
        source: "GitHub repo → Settings → Secrets and variables → Actions → New repository secret (value: SSH port, e.g. 22)"
      - name: VPS_SSH_PRIVATE_KEY
        source: "GitHub repo → Settings → Environments → New environment 'production' → Add secret (value: full private key including BEGIN/END lines, generated with ssh-keygen -t ed25519)"
    dashboard_config:
      - task: "Create 'production' environment with deployment branch restriction to 'main'"
        location: "GitHub repo → Settings → Environments → New environment → 'production' → Deployment branches: 'main' only"

must_haves:
  truths:
    - "Deploy workflow triggers on push to main and executes deploy.sh on VPS via SSH"
    - "Concurrent deployments are prevented by concurrency group"
    - "Deploy script verifies health check after PM2 restart and fails if unhealthy"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "Production deployment via SSH with concurrency control"
      contains: "appleboy/ssh-action"
    - path: "scripts/deploy.sh"
      provides: "Deployment script with health check verification"
      contains: "curl.*localhost:3000/health"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "scripts/deploy.sh"
      via: "SSH execution of bash scripts/deploy.sh"
      pattern: "scripts/deploy\\.sh"
    - from: "scripts/deploy.sh"
      to: "localhost:3000/health"
      via: "curl health check after PM2 restart"
      pattern: "curl.*localhost:3000/health"
---

<objective>
Create the deployment workflow and enhance deploy.sh with health check verification.

Purpose: Automate production deployment when code merges to main, with concurrency controls to protect Signal bot state and health check verification to catch failed deployments. The deploy.sh script gains post-restart verification so both GitHub Actions and manual deployments benefit from health checking.

Output: Deploy workflow file (.github/workflows/deploy.yml) and enhanced deploy.sh with health check step.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@scripts/deploy.sh
@ecosystem.config.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance deploy.sh with health check verification</name>
  <files>scripts/deploy.sh</files>
  <action>
Update the existing `scripts/deploy.sh` to add health check verification after PM2 restart. Add these steps AFTER the existing `pm2 save` step:

1. Wait for application to start: `sleep 5`
2. Verify health endpoint: `curl -f http://localhost:3000/health > /dev/null 2>&1`
3. If health check fails, print PM2 logs for debugging and exit with code 1
4. If health check passes, print success message

The enhanced script should look like the existing script with these additions appended before the final status output. Keep the existing `set -euo pipefail`, `cd` command, and all current steps (git pull, npm ci, migrations, pm2 restart, pm2 save) exactly as they are.

Add numbered step labels consistent with existing style (currently steps 1-5, add 6 and 7 for wait and health check).

Important: The health check must use `curl -f` (fail on HTTP errors) so a non-200 response causes the script to exit 1, which GitHub Actions will detect as deployment failure.
</action>
<verify>
Read `scripts/deploy.sh` and confirm:

- All original steps preserved (git pull, npm ci, migrations, pm2 restart, pm2 save)
- Health check step added with `curl -f http://localhost:3000/health`
- Script exits 1 on health check failure
- PM2 logs shown on failure for debugging
  </verify>
  <done>
  deploy.sh includes health check verification after PM2 restart. Failed health checks cause the script to exit 1 with PM2 log output for debugging.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Create deployment workflow with concurrency control</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Create `.github/workflows/deploy.yml` for production deployment via SSH.

Configuration:

- **Triggers:** `push` to `main` branch AND `workflow_dispatch` (manual trigger)
- **Permissions:** `contents: read` (least privilege)
- **Concurrency:** group `production-deployment` with `cancel-in-progress: false` (never interrupt an in-progress deployment — critical for Signal bot's stateful nature)
- **Timeout:** 15 minutes for the deploy job

Job `deploy`:

- `runs-on: ubuntu-latest`
- `environment: name: production` (uses GitHub environment for secret isolation and branch protection)

Steps:

1. **Deploy via SSH** — Use `appleboy/ssh-action@v1` with:
   - `host: ${{ secrets.VPS_HOST }}`
   - `username: ${{ secrets.VPS_USERNAME }}`
   - `key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}`
   - `port: ${{ secrets.VPS_PORT }}`
   - `timeout: 10m`
   - `command_timeout: 10m`
   - `script:` that does `set -e`, `cd /opt/family-coordinator`, and `bash scripts/deploy.sh`

2. **Verify deployment** — Second `appleboy/ssh-action@v1` step (same SSH credentials) that:
   - Runs `pm2 status family-coordinator` to show process state
   - Runs `curl -f http://localhost:3000/health` with failure handler that shows PM2 logs and exits 1

This second verification step acts as a safety net — deploy.sh already has health checking, but this confirms from the workflow level that the VPS is healthy after the full deployment completes.

Do NOT use `${{ secrets.VPS_PORT || 22 }}` syntax — GitHub Actions does not support default values in expression syntax. Just use `${{ secrets.VPS_PORT }}` (user sets it in secrets).
</action>
<verify>
Validate YAML syntax and confirm file exists at `.github/workflows/deploy.yml`.
Confirm concurrency group is set with cancel-in-progress: false.
Confirm environment is set to 'production'.
Confirm appleboy/ssh-action@v1 is used with correct secret references.
</verify>
<done>
Deploy workflow exists at .github/workflows/deploy.yml. Triggers on main push and manual dispatch. Uses concurrency controls to prevent parallel deployments. Deploys via SSH using appleboy/ssh-action and verifies health check.
</done>
</task>

</tasks>

<verification>
- [ ] `scripts/deploy.sh` has health check verification after PM2 restart
- [ ] `.github/workflows/deploy.yml` exists with SSH-based deployment
- [ ] Deploy workflow has `concurrency: cancel-in-progress: false`
- [ ] Deploy workflow uses `environment: production`
- [ ] Deploy workflow uses `appleboy/ssh-action@v1` with secrets for host, username, key, port
- [ ] Deploy workflow has `workflow_dispatch` for manual triggers
- [ ] Deploy workflow has `timeout-minutes: 15`
</verification>

<success_criteria>
Deployment pipeline fully configured: deploy.sh enhanced with health check verification (benefits both manual and automated deployments), and deploy.yml workflow automates VPS deployment on main merge with concurrency controls protecting Signal bot state.
</success_criteria>

<output>
After completion, create `.planning/phases/06-github-ci-cd-pipeline/06-02-SUMMARY.md`
</output>
